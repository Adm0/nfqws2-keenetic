find_policy() {
  local NAME=$1

  local MARK=$(/bin/ndmc -c show ip policy 2>&1 | grep -i "description = $NAME:" -A 1 | grep 'mark:' | grep -o '[^ ]*$' | head -n 1)
  if [ -n "$MARK" ]; then
    echo "0x$MARK/0x0fffffff"
    if [ -n "$POLICY_EXCLUDE" ] && [ "$POLICY_EXCLUDE" -ne "0" ]; then
      echo "Found policy '$POLICY_NAME'. Traffic from it will be excluded from processing." >&2
    else
      echo "Found policy '$POLICY_NAME'. Only traffic from it will be processed." >&2
    fi
  fi
}

start() {
  if is_running; then
    echo 'Service NFQWS2 is already running' >&2
    return 1
  fi

  validate_config || return 1
  create_running_config
  kernel_modules

  $NFQWS_BIN --daemon --pidfile=$PIDFILE $(_startup_args)

  firewall_start
  system_config

  echo 'Started NFQWS2 service'
}

stop() {
  firewall_stop

  if ! is_running; then
    echo 'Service NFQWS2 is not running' >&2
    return 1
  fi

  echo 'Stopping NFQWS2 service...'
  kill -15 $(cat "$PIDFILE") && rm -f "$PIDFILE"
  remove_running_config
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  status)
    status_service
    ;;
  restart)
    stop
    start
    ;;
  reload)
    reload_service
    ;;
  firewall_reload)
    firewall_reload "$2" "$3"
    ;;
  firewall_start)
    firewall_start
    ;;
  firewall_stop)
    firewall_stop
    ;;
  kernel_modules)
    kernel_modules
    ;;
  *)
    echo "Usage: $0 {start|stop|restart|reload|status}"
esac
